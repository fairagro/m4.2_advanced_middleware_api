apiVersion: v1
kind: Secret
metadata:
  name: {{ include "fairagro-advanced-middleware-api-chart.fullname" . }}-config
  labels:
    {{- include "fairagro-advanced-middleware-api-chart.labels" . | nindent 4 }}
type: Opaque
stringData:
  middleware-api-config: |
{{- $config := deepCopy .Values.config -}}
{{- if not $config.couchdb -}}
  {{- $_ := set $config "couchdb" (dict) -}}
{{- end -}}
{{- if not $config.couchdb.url -}}
  {{- $_ := set $config.couchdb "url" (include "fairagro-advanced-middleware-api-chart.couchdbUrl" . | trim) -}}
{{- end -}}
{{- if not $config.celery -}}
  {{- $_ := set $config "celery" (dict) -}}
{{- end -}}
{{- if not $config.celery.broker_url -}}
  {{- $_ := set $config.celery "broker_url" (include "fairagro-advanced-middleware-api-chart.celeryBrokerUrl" . | trim) -}}
{{- end -}}
{{- if not $config.celery.result_backend -}}
  {{- $_ := set $config.celery "result_backend" (include "fairagro-advanced-middleware-api-chart.celeryResultBackend" . | trim) -}}
{{- end -}}
{{- $config | toYaml | indent 4 }}
