services:
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER
      - RABBITMQ_DEFAULT_PASS
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  couchdb:
    image: couchdb:3.3
    ports:
      - "5984:5984"
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-password}
    volumes:
      - couchdb_data:/opt/couchdb/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  couchdb-init:
    image: middleware-api:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    depends_on:
      couchdb:
        condition: service_healthy
    environment:
      - MIDDLEWARE_API_CONFIG=/run/secrets/middleware-api-config
      - COUCHDB_URL=http://couchdb:5984
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-password}
    volumes:
      - ./middleware-api-config.yaml:/run/secrets/middleware-api-config:ro
    command: ["/api/middleware-api/middleware-api", "setup-couchdb"]
    restart: "no"

  celery-worker:
    image: middleware-api:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      couchdb-init:
        condition: service_completed_successfully
      middleware-api:
        condition: service_started
    environment:
      - MIDDLEWARE_API_CONFIG=/run/secrets/middleware-api-config
      - CELERY_BROKER_URL
      - CELERY_RESULT_BACKEND
      - GITLAB_API_TOKEN
      - GIT_REPO_TOKEN
      - COUCHDB_URL=http://couchdb:5984
      - COUCHDB_USER=${COUCHDB_USER}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
    volumes:
      - ./middleware-api-config.yaml:/run/secrets/middleware-api-config:ro
    # Command to run celery worker
    command: [
      "/api/middleware-api/middleware-api",
      "celery",
      "-A", "middleware.api.celery_app",
      "worker",
      "--loglevel=info",
      "--concurrency=8",]
    restart: unless-stopped

  middleware-api:
    image: middleware-api:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      couchdb-init:
        condition: service_completed_successfully
    ports:
      - "8000:8000"
    environment:
      - CELERY_BROKER_URL
      - CELERY_RESULT_BACKEND
      - MIDDLEWARE_API_CONFIG=/run/secrets/middleware-api-config
      - COUCHDB_URL=http://couchdb:5984
      - COUCHDB_USER=${COUCHDB_USER}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
    volumes:
      - ./middleware-api-config.yaml:/run/secrets/middleware-api-config:ro
    # Run uvicorn directly (default command of the binary runs uvicorn)
    command: ["/api/middleware-api/middleware-api", "--host", "0.0.0.0", "--port", "8000"]
    # command: sleep 3600
    restart: unless-stopped

# secrets:
#   client_key:
#     environment: data

volumes:
  couchdb_data:
